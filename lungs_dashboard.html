<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulmonary Analysis | Kenko</title>
    
    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons: Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a', 
                        },
                        medical: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6', 
                            600: '#2563eb', 
                            900: '#1e3a8a',
                        },
                        sky: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        emerald: {
                            500: '#10b981',
                            600: '#059669',
                        }
                    },
                    backgroundImage: {
                        'grid-pattern': "linear-gradient(to right, #cbd5e1 1px, transparent 1px), linear-gradient(to bottom, #cbd5e1 1px, transparent 1px)",
                    },
                    backgroundSize: {
                        'grid-size': '40px 40px',
                    },
                    boxShadow: {
                        'sharp': '4px 4px 0 0 #0f172a',
                        'sharp-sm': '2px 2px 0 0 #0f172a',
                    },
                }
            }
        }
    </script>

    <style>
        /* Smooth Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-card { opacity: 0; animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Graph Animations */
        @keyframes growBar {
            from { height: 0; }
            to { height: var(--target-height); }
        }
        .bar-animate { animation: growBar 1s ease-out forwards; height: 0; }

        @keyframes drawLine {
            to { stroke-dashoffset: 0; }
        }
        .line-draw {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: drawLine 2s ease-out forwards;
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        .scan-beam {
            animation: scan 3s linear infinite;
        }
        
        /* Sidebar Active */
        .nav-item.active {
            background-color: white;
            border-color: #0f172a;
            color: #0f172a;
            box-shadow: 2px 2px 0 0 #0f172a;
        }
        .nav-item { border: 2px solid transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen w-screen overflow-hidden flex selection:bg-sky-100 selection:text-sky-900 font-medium">

    <!-- 1. LEFT SIDEBAR -->
    <aside class="w-64 bg-white border-r-2 border-slate-900 flex flex-col h-full shrink-0 z-20">
        <div class="h-16 flex items-center px-6 border-b-2 border-slate-900">
            <div class="flex items-center gap-2.5">
                <div class="bg-slate-900 text-white p-1 rounded shadow-sm border border-slate-900">
                    <i data-lucide="plus-square" class="w-4 h-4"></i>
                </div>
                <span class="font-extrabold text-lg tracking-tight text-slate-900">Kenko</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto py-6 px-3 space-y-8">
            <div>
                <h3 class="px-3 text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-3">Core Modules</h3>
                <nav class="space-y-1">
                    <a href="dashboard.html" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-100 transition-colors group border-2 border-transparent">
                        <i data-lucide="layout-grid" class="w-5 h-5 text-slate-400 group-hover:text-sky-600"></i>
                        Main Dashboard
                    </a>
                    <!-- Active Module -->
                    <button class="nav-item active w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-100 transition-colors group">
                        <i data-lucide="wind" class="w-5 h-5 group-hover:text-sky-600"></i>
                        Lungs Analysis
                    </button>
                </nav>
            </div>
            
            <!-- Quick History specific to Lungs -->
            <div>
                 <h3 class="px-3 text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-3">Recent Scans</h3>
                 <div class="space-y-2 px-3">
                     <div class="flex items-center gap-2 text-xs text-slate-600 p-2 border border-slate-200 rounded bg-slate-50 cursor-pointer hover:bg-white">
                         <div class="w-2 h-2 rounded-full bg-red-500"></div> #PUL-882 (Pneumonia)
                     </div>
                     <div class="flex items-center gap-2 text-xs text-slate-600 p-2 border border-slate-200 rounded bg-slate-50 cursor-pointer hover:bg-white">
                         <div class="w-2 h-2 rounded-full bg-green-500"></div> #PUL-881 (Normal)
                     </div>
                 </div>
            </div>
        </div>

        <div class="p-4 border-t-2 border-slate-900 bg-slate-50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white border-2 border-slate-900 flex items-center justify-center font-bold text-slate-900">MD</div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-slate-900 truncate">Dr. Pathologist</p>
                    <p class="text-xs text-slate-500 truncate">Pulmonology Lead</p>
                </div>
                <button class="text-slate-400 hover:text-slate-900"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            </div>
        </div>
    </aside>

    <!-- 2. MAIN CONTENT AREA -->
    <div class="flex-1 flex flex-col h-full overflow-hidden bg-grid-pattern bg-grid-size relative">
        <div class="absolute inset-0 bg-slate-50/90 z-0"></div>

        <!-- TOP NAVBAR -->
        <header class="h-16 bg-white border-b-2 border-slate-900 flex items-center justify-between px-6 z-10 shrink-0">
            <div class="flex items-center gap-4">
                <span class="px-3 py-1 bg-sky-100 text-sky-800 border-2 border-sky-200 rounded-lg text-xs font-bold flex items-center gap-2">
                    <span class="w-2 h-2 bg-sky-500 rounded-full live-indicator"></span> Analysis Engine V4.2
                </span>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-xs text-right hidden md:block">
                    <p class="font-bold text-slate-900">System Status</p>
                    <p class="text-slate-500">All Nodes Operational</p>
                </div>
                <div class="h-8 w-px bg-slate-200"></div>
                <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100"><i data-lucide="bell" class="w-4 h-4"></i></button>
                <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100"><i data-lucide="help-circle" class="w-4 h-4"></i></button>
            </div>
        </header>

        <!-- DASHBOARD CONTENT -->
        <main class="flex-1 overflow-y-auto p-6 z-10">

            <!-- PAGE HEADER -->
            <div class="flex justify-between items-center mb-8 animate-card">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900">Lungs Analysis</h1>
                    <p class="text-slate-500 font-medium mt-1">AI-assisted lung disease detection using X-Ray & CT scans</p>
                </div>
                <button onclick="window.location.reload()" class="px-4 py-2 border-2 border-slate-900 rounded-lg font-bold text-sm bg-white hover:bg-slate-50 flex items-center gap-2 shadow-sharp-sm active:translate-y-0.5 transition-all">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i> New Session
                </button>
            </div>

            <!-- ===================== STATE 1: UPLOAD ===================== -->
            <div id="state-upload" class="flex flex-col items-center justify-center py-12 animate-card">
                <div class="bg-white border-2 border-slate-900 rounded-xl p-12 text-center max-w-xl w-full shadow-sharp-sm transition-all duration-300 hover:shadow-sharp">
                    <div class="w-24 h-24 bg-sky-50 border-2 border-dashed border-sky-400 rounded-full flex items-center justify-center mx-auto mb-8">
                        <i data-lucide="wind" class="w-10 h-10 text-sky-600"></i>
                    </div>
                    <h3 class="text-2xl font-extrabold text-slate-900 mb-3">Upload Chest Scan</h3>
                    <p class="text-slate-500 mb-8 font-medium">Upload Chest X-Ray (CXR) or CT DICOM series for analysis.</p>
                    
                    <!-- File Input -->
                    <label class="block w-full cursor-pointer group">
                        <input type="file" class="hidden" id="file-upload" onchange="handleLungUpload(event)">
                        <div class="w-full py-4 bg-slate-900 text-white font-bold rounded-xl shadow-sharp hover:translate-y-[-2px] hover:shadow-sharp-sm transition-all flex items-center justify-center gap-3 group-hover:bg-slate-800">
                            <i data-lucide="upload" class="w-5 h-5"></i> Browse Files
                        </div>
                    </label>
                    
                    <div class="mt-8 flex justify-center gap-6 text-xs text-slate-400 font-bold border-t border-slate-100 pt-6">
                        <span class="flex items-center gap-1"><i data-lucide="image" class="w-3 h-3"></i> DICOM</span>
                        <span class="flex items-center gap-1"><i data-lucide="file-image" class="w-3 h-3"></i> PNG</span>
                        <span class="flex items-center gap-1"><i data-lucide="file" class="w-3 h-3"></i> JPEG (Max 500MB)</span>
                    </div>
                </div>
            </div>

            <!-- ===================== STATE 2: PROCESSING (Animated) ===================== -->
            <div id="state-processing" class="hidden max-w-4xl mx-auto py-12">
                <div class="bg-white border-2 border-slate-900 rounded-xl p-8 shadow-sharp-sm mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-bold text-lg text-slate-900 flex items-center gap-2">
                            <i data-lucide="loader" class="w-5 h-5 animate-spin text-sky-600"></i>
                            Processing Scan...
                        </h3>
                        <span class="font-mono text-sm font-bold text-sky-600" id="proc-percent">0%</span>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="w-full h-3 bg-slate-100 rounded-full border border-slate-200 overflow-hidden mb-8">
                        <div id="proc-bar" class="h-full bg-sky-500 w-0 transition-all duration-300 ease-out"></div>
                    </div>

                    <!-- Pipeline Steps -->
                    <div class="grid grid-cols-5 gap-4">
                        <div class="text-center opacity-50 transition-opacity duration-300" id="step-1">
                            <div class="w-8 h-8 rounded-full border-2 border-slate-300 bg-slate-50 flex items-center justify-center mx-auto mb-2 icon-box">
                                <i data-lucide="image" class="w-4 h-4 text-slate-400"></i>
                            </div>
                            <p class="text-[10px] font-bold text-slate-500 uppercase">Normalization</p>
                        </div>
                        <div class="text-center opacity-50 transition-opacity duration-300" id="step-2">
                            <div class="w-8 h-8 rounded-full border-2 border-slate-300 bg-slate-50 flex items-center justify-center mx-auto mb-2 icon-box">
                                <i data-lucide="scissors" class="w-4 h-4 text-slate-400"></i>
                            </div>
                            <p class="text-[10px] font-bold text-slate-500 uppercase">Segmentation</p>
                        </div>
                        <div class="text-center opacity-50 transition-opacity duration-300" id="step-3">
                            <div class="w-8 h-8 rounded-full border-2 border-slate-300 bg-slate-50 flex items-center justify-center mx-auto mb-2 icon-box">
                                <i data-lucide="eye" class="w-4 h-4 text-slate-400"></i>
                            </div>
                            <p class="text-[10px] font-bold text-slate-500 uppercase">Opacity Detection</p>
                        </div>
                        <div class="text-center opacity-50 transition-opacity duration-300" id="step-4">
                            <div class="w-8 h-8 rounded-full border-2 border-slate-300 bg-slate-50 flex items-center justify-center mx-auto mb-2 icon-box">
                                <i data-lucide="microscope" class="w-4 h-4 text-slate-400"></i>
                            </div>
                            <p class="text-[10px] font-bold text-slate-500 uppercase">Classification</p>
                        </div>
                        <div class="text-center opacity-50 transition-opacity duration-300" id="step-5">
                            <div class="w-8 h-8 rounded-full border-2 border-slate-300 bg-slate-50 flex items-center justify-center mx-auto mb-2 icon-box">
                                <i data-lucide="clipboard-check" class="w-4 h-4 text-slate-400"></i>
                            </div>
                            <p class="text-[10px] font-bold text-slate-500 uppercase">Risk Scoring</p>
                        </div>
                    </div>
                </div>

                <!-- Live Metrics during processing -->
                <div class="grid grid-cols-4 gap-4">
                    <div class="bg-white border-2 border-slate-900 rounded-lg p-4 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase font-bold">Elapsed Time</p>
                        <p class="text-xl font-mono font-bold text-slate-900 mt-1" id="proc-time">0.0s</p>
                    </div>
                    <div class="bg-white border-2 border-slate-900 rounded-lg p-4 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase font-bold">Regions</p>
                        <p class="text-xl font-mono font-bold text-slate-900 mt-1">Analyzing...</p>
                    </div>
                     <div class="bg-white border-2 border-slate-900 rounded-lg p-4 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase font-bold">Anomalies</p>
                        <p class="text-xl font-mono font-bold text-slate-900 mt-1">--</p>
                    </div>
                     <div class="bg-white border-2 border-slate-900 rounded-lg p-4 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase font-bold">Model Confidence</p>
                        <p class="text-xl font-mono font-bold text-slate-900 mt-1">Calculating...</p>
                    </div>
                </div>
            </div>

            <!-- ===================== STATE 3: VISUAL ANALYSIS DASHBOARD ===================== -->
            <div id="state-results" class="hidden">
                
                <div class="grid lg:grid-cols-3 gap-6">
                    
                    <!-- LEFT PANEL: VIEWER -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Chest Viewer Card -->
                        <div class="bg-white border-2 border-slate-900 rounded-xl p-6 shadow-sharp-sm animate-card" style="animation-delay: 0.1s;">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="font-bold text-sm text-slate-900 flex items-center gap-2">
                                        <i data-lucide="scan" class="w-4 h-4 text-sky-600"></i> Chest X-Ray Viewer
                                    </h3>
                                    <p class="text-xs text-slate-500 mt-0.5">Filename: <span id="res-filename" class="font-bold text-slate-900">scan.dcm</span></p>
                                </div>
                                <div class="flex gap-2">
                                    <button class="p-2 border-2 border-slate-200 rounded hover:bg-slate-50" title="Zoom In"><i data-lucide="zoom-in" class="w-4 h-4"></i></button>
                                    <button class="p-2 border-2 border-slate-200 rounded hover:bg-slate-50" title="Zoom Out"><i data-lucide="zoom-out" class="w-4 h-4"></i></button>
                                    <button class="px-3 py-1.5 border-2 border-slate-900 rounded font-bold text-xs bg-slate-900 text-white hover:bg-slate-800" onclick="toggleOverlay()">Toggle AI Overlay</button>
                                </div>
                            </div>
                            
                            <div class="relative aspect-[4/3] bg-slate-900 rounded-lg border-2 border-slate-900 overflow-hidden group">
                                <img 
  src="lungs.png"
  class="w-full h-full object-contain bg-black">

                                
                                <!-- Heatmap Overlay (Initially Hidden) -->
                                <div id="result-overlay" class="absolute inset-0 transition-opacity duration-500 opacity-100 mix-blend-screen" style="background: radial-gradient(circle at 65% 45%, rgba(239, 68, 68, 0.6) 0%, transparent 20%), radial-gradient(circle at 35% 50%, rgba(245, 158, 11, 0.5) 0%, transparent 25%);"></div>
                                
                                <!-- ROI Boxes -->
                                <div class="absolute top-[40%] right-[30%] w-24 h-24 border-2 border-red-500 rounded-lg shadow-[0_0_15px_rgba(239,68,68,0.5)] flex items-start justify-end p-1 animate-pulse-slow">
                                    <div class="bg-red-500 text-white text-[8px] font-bold px-1 rounded shadow-sm">Opacity 0.92</div>
                                </div>
                                
                                <!-- Scan Beam -->
                                <div class="absolute top-0 left-0 w-full h-1 bg-sky-400 shadow-[0_0_20px_rgba(14,165,233,1)] scan-beam opacity-30"></div>
                            </div>
                            
                            <div class="mt-4 flex gap-6 text-xs font-bold">
                                <span class="flex items-center gap-2"><div class="w-3 h-3 bg-red-500 rounded-sm"></div> Critical Opacity</span>
                                <span class="flex items-center gap-2"><div class="w-3 h-3 bg-amber-500 rounded-sm"></div> Inflammation</span>
                                <span class="flex items-center gap-2"><div class="w-3 h-3 bg-emerald-500 rounded-sm"></div> Normal Tissue</span>
                            </div>
                        </div>

                        <!-- Graph 2: Opacity Intensity Curve (Line) -->
                        <div class="bg-white border-2 border-slate-900 rounded-xl p-6 shadow-sharp-sm animate-card" style="animation-delay: 0.2s;">
                            <h3 class="font-bold text-sm text-slate-900 mb-6">Opacity Intensity Profile (Zonal)</h3>
                            <div class="h-48 w-full relative">
                                <!-- SVG Line Chart -->
                                <svg viewBox="0 0 500 150" class="w-full h-full overflow-visible">
                                    <!-- Grid -->
                                    <line x1="0" y1="30" x2="500" y2="30" stroke="#f1f5f9" stroke-width="1"/>
                                    <line x1="0" y1="75" x2="500" y2="75" stroke="#f1f5f9" stroke-width="1"/>
                                    <line x1="0" y1="120" x2="500" y2="120" stroke="#f1f5f9" stroke-width="1"/>
                                    
                                    <!-- Axes Text -->
                                    <text x="0" y="145" font-size="10" fill="#64748b" font-weight="bold">R-Upper</text>
                                    <text x="125" y="145" font-size="10" fill="#64748b" font-weight="bold">R-Lower</text>
                                    <text x="250" y="145" font-size="10" fill="#64748b" font-weight="bold">Mid-Zone</text>
                                    <text x="375" y="145" font-size="10" fill="#64748b" font-weight="bold">L-Upper</text>
                                    <text x="500" y="145" font-size="10" fill="#64748b" font-weight="bold" text-anchor="end">L-Lower</text>

                                    <!-- The Line -->
                                    <path d="M0,110 Q60,100 125,40 T250,80 T375,100 T500,115" 
                                          fill="none" stroke="#0ea5e9" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                                          class="line-draw" />
                                    
                                    <!-- Area Fill (Optional, using polygon for simplicity) -->
                                    <polygon points="0,150 0,110 60,105 125,40 185,55 250,80 310,90 375,100 435,108 500,115 500,150" fill="rgba(14, 165, 233, 0.1)" />

                                    <!-- Points -->
                                    <circle cx="125" cy="40" r="6" fill="#ef4444" stroke="#fff" stroke-width="2" class="animate-pulse" />
                                    <text x="125" y="25" font-size="10" fill="#ef4444" font-weight="bold" text-anchor="middle">High Density</text>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT PANEL: SUMMARY & GRAPHS -->
                    <div class="space-y-6">
                        
                        <!-- AI Summary Card -->
                        <div class="bg-white border-2 border-slate-900 rounded-xl p-6 shadow-sharp-sm animate-card" style="animation-delay: 0.15s;">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase">Detected Condition</p>
                                    <h2 class="text-2xl font-extrabold text-red-600">Pneumonia (Viral)</h2>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs font-bold text-slate-400 uppercase">Confidence</p>
                                    <p class="text-2xl font-extrabold text-slate-900">94.8%</p>
                                </div>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden border border-slate-200">
                                <div class="bg-red-500 h-full bar-animate" style="--target-height: 100%; width: 94.8%"></div>
                            </div>
                            <p class="text-xs font-bold text-slate-500 mt-2">Severity: <span class="text-red-600">Critical / High</span></p>
                        </div>

                        <!-- Graph 1: Disease Probability (Bar) -->
                        <div class="bg-white border-2 border-slate-900 rounded-xl p-6 shadow-sharp-sm animate-card" style="animation-delay: 0.25s;">
                            <h3 class="font-bold text-sm text-slate-900 mb-4">Disease Probability Model</h3>
                            <div class="space-y-3">
                                <!-- Pneumonia -->
                                <div>
                                    <div class="flex justify-between text-xs font-bold mb-1">
                                        <span class="text-red-700">Pneumonia</span>
                                        <span>78%</span>
                                    </div>
                                    <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                        <div class="bg-red-500 h-full bar-animate" style="width: 78%; --target-height: 100%"></div>
                                    </div>
                                </div>
                                <!-- COVID -->
                                <div>
                                    <div class="flex justify-between text-xs font-bold mb-1">
                                        <span class="text-amber-700">COVID-19</span>
                                        <span>45%</span>
                                    </div>
                                    <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                        <div class="bg-amber-500 h-full bar-animate" style="width: 45%; --target-height: 100%; animation-delay: 0.2s"></div>
                                    </div>
                                </div>
                                <!-- Normal -->
                                <div>
                                    <div class="flex justify-between text-xs font-bold mb-1">
                                        <span class="text-emerald-700">Normal</span>
                                        <span>12%</span>
                                    </div>
                                    <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                        <div class="bg-emerald-500 h-full bar-animate" style="width: 12%; --target-height: 100%; animation-delay: 0.4s"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Graph 3: Tissue Distribution (Donut) -->
                        <div class="bg-white border-2 border-slate-900 rounded-xl p-6 shadow-sharp-sm animate-card" style="animation-delay: 0.3s;">
                            <h3 class="font-bold text-sm text-slate-900 mb-4">Tissue Distribution</h3>
                            <div class="flex items-center justify-between">
                                <div class="relative w-28 h-28">
                                    <svg viewBox="0 0 36 36" class="w-full h-full rotate-[-90deg]">
                                        <!-- Ring -->
                                        <path class="text-slate-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" />
                                        <!-- Healthy -->
                                        <path class="text-sky-500 donut-segment" stroke-dasharray="60, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" />
                                        <!-- Affected -->
                                        <path class="text-red-500 donut-segment" stroke-dasharray="30, 100" stroke-dashoffset="-60" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" />
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                                        <span class="text-xs font-bold text-slate-400">Affected</span>
                                        <span class="text-lg font-extrabold text-slate-900">30%</span>
                                    </div>
                                </div>
                                <div class="space-y-2 text-xs font-bold">
                                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-sky-500"></span> 60% Healthy</div>
                                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500"></span> 30% Affected</div>
                                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-slate-300"></span> 10% Other</div>
                                </div>
                            </div>
                        </div>

                        <!-- Graph 4: Region Heatmap (Grid) -->
                        <div class="bg-white border-2 border-slate-900 rounded-xl p-6 shadow-sharp-sm animate-card" style="animation-delay: 0.35s;">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-sm text-slate-900">Zonal Heatmap</h3>
                                <span class="text-[10px] bg-slate-100 px-2 py-1 rounded font-bold text-slate-500">Hover for details</span>
                            </div>
                            <div class="grid grid-cols-5 gap-1 aspect-[2/1]" id="lung-grid">
                                <!-- JS will populate this -->
                            </div>
                        </div>

                        <!-- Step 5: Clinical Interpretation -->
                        <div class="bg-slate-900 text-white rounded-xl p-6 shadow-sharp-sm animate-card" style="animation-delay: 0.4s;">
                            <h3 class="font-bold text-sm text-white mb-3 flex items-center gap-2"><i data-lucide="stethoscope" class="w-4 h-4"></i> Clinical Interpretation</h3>
                            <p class="text-xs text-slate-300 leading-relaxed mb-4">
                                Findings indicate high probability of <strong class="text-white">Viral Pneumonia</strong>. 
                                Significant consolidation observed in the lower right lobe (Zone R-Lower). 
                                Ground glass opacities present in the mid-zones.
                            </p>
                            <div class="space-y-2 text-xs font-medium border-t border-slate-700 pt-3">
                                <div class="flex justify-between"><span>Primary Finding:</span> <span class="text-red-400">Consolidation</span></div>
                                <div class="flex justify-between"><span>Secondary:</span> <span class="text-amber-400">Ground Glass Opacity</span></div>
                                <div class="flex justify-between"><span>Action:</span> <span class="font-bold text-white bg-red-600 px-2 rounded">URGENT FOLLOW-UP</span></div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Final Action Bar -->
                <div class="mt-8 flex justify-end gap-4 animate-card" style="animation-delay: 0.5s;">
                    <button onclick="window.location.reload()" class="px-6 py-3 bg-white border-2 border-slate-900 text-slate-900 font-bold rounded-xl hover:bg-slate-50 transition-colors">
                        Re-upload Scan
                    </button>
                    <button onclick="alert('Report Exported!')" class="px-6 py-3 bg-slate-900 text-white font-bold rounded-xl shadow-sharp hover:translate-y-[-2px] transition-all flex items-center gap-2">
                        Proceed to Review <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </div>

            </div>

        </main>
    </div>

    <!-- LOGIC SCRIPT -->
    <script>
        lucide.createIcons();

        function handleLungUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 1. Transition to Processing State
            document.getElementById('state-upload').classList.add('hidden');
            document.getElementById('state-processing').classList.remove('hidden');

            // 2. Simulate Processing
            startProcessingSimulation(file.name);
        }

        function startProcessingSimulation(filename) {
            let progress = 0;
            const bar = document.getElementById('proc-bar');
            const pct = document.getElementById('proc-percent');
            const timeDisplay = document.getElementById('proc-time');
            let startTime = Date.now();

            const steps = ['step-1', 'step-2', 'step-3', 'step-4', 'step-5'];
            let currentStep = 0;

            const interval = setInterval(() => {
                progress += Math.floor(Math.random() * 5) + 1;
                if (progress > 100) progress = 100;

                // Update UI
                bar.style.width = `${progress}%`;
                pct.innerText = `${progress}%`;
                timeDisplay.innerText = ((Date.now() - startTime) / 1000).toFixed(1) + 's';

                // Update Steps Visuals
                if (progress > 20 && currentStep < 1) activateStep(steps[0]);
                if (progress > 40 && currentStep < 2) activateStep(steps[1]);
                if (progress > 60 && currentStep < 3) activateStep(steps[2]);
                if (progress > 80 && currentStep < 4) activateStep(steps[3]);
                if (progress > 95 && currentStep < 5) activateStep(steps[4]);

                if (progress === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        showResults(filename);
                    }, 500);
                }
            }, 100);
        }

        function activateStep(id) {
            const el = document.getElementById(id);
            el.classList.remove('opacity-50');
            el.classList.add('opacity-100');
            const iconBox = el.querySelector('.icon-box');
            iconBox.classList.remove('border-slate-300', 'bg-slate-50');
            iconBox.classList.add('border-emerald-500', 'bg-emerald-50', 'text-emerald-600');
            
            // Replace icon with check (optional visual flair)
            // const icon = iconBox.querySelector('i'); 
            // icon.setAttribute('data-lucide', 'check'); // Would need re-init
        }

        function showResults(filename) {
            document.getElementById('state-processing').classList.add('hidden');
            document.getElementById('state-results').classList.remove('hidden');
            document.getElementById('res-filename').innerText = filename;
            
            // Render Heatmap Grid
            renderHeatmapGrid();
        }

        function toggleOverlay() {
            const overlay = document.getElementById('result-overlay');
            overlay.classList.toggle('opacity-0');
        }

        function renderHeatmapGrid() {
            const grid = document.getElementById('lung-grid');
            grid.innerHTML = '';
            // 5x3 Grid (15 zones)
            for(let i=0; i<15; i++) {
                const cell = document.createElement('div');
                cell.className = 'w-full h-full rounded bg-slate-100 hover:scale-110 transition-transform cursor-pointer border border-white';
                
                // Simulate data
                if([12, 13, 14].includes(i)) {
                    cell.classList.add('bg-red-500'); // Bottom right affected
                    cell.title = "Critical Density";
                } else if ([7, 8].includes(i)) {
                    cell.classList.add('bg-amber-400'); // Mid zone
                    cell.title = "Moderate Opacity";
                } else {
                    cell.classList.add('bg-emerald-400'); // Normal
                    cell.title = "Normal Tissue";
                }
                grid.appendChild(cell);
            }
        }
    </script>
</body>
</html>
